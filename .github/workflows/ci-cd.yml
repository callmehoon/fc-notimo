name: CI/CD Pipeline

# ===========================================
# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ê²ƒì¸ê°€?
# ===========================================
on:
  push:
    branches:
      - dev   # dev ë¸Œëžœì¹˜: CI + ê°œë°œ í™˜ê²½ ë°°í¬
      - main  # main ë¸Œëžœì¹˜: ìš´ì˜ í™˜ê²½ ë°°í¬
  pull_request:
    branches:
      - main  # mainìœ¼ë¡œì˜ PR: CIë§Œ ì‹¤í–‰

# ===========================================
# ì‹¤í–‰í•  ìž‘ì—…(Job)ë“¤
# ===========================================
jobs:
  # -------------------------------------------
  # CI Job: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ (dev ë¸Œëžœì¹˜, PR)
  # -------------------------------------------
  ci:
    # dev ë¸Œëžœì¹˜ í‘¸ì‹œ ë˜ëŠ” mainìœ¼ë¡œì˜ PRì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/dev' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ðŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. Java 21 í™˜ê²½ ì„¤ì •
      - name: â˜• Java 21 í™˜ê²½ ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: ðŸ“¦ Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: ðŸ”§ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      # 5. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: ðŸ”¨ Spring Boot ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew clean build

  # -------------------------------------------
  # ê°œë°œ í™˜ê²½ ë°°í¬ Job (dev ë¸Œëžœì¹˜ë§Œ)
  # -------------------------------------------
  deploy-dev:
    # dev ë¸Œëžœì¹˜ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰ + CI ì„±ê³µ í›„
    if: github.ref == 'refs/heads/dev'
    needs: ci
    runs-on: ubuntu-latest

    steps:
      # EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ê°œë°œ í™˜ê²½ ë°°í¬
      - name: ðŸš€ ê°œë°œí™˜ê²½ ë°°í¬ (dev.notimo.kro.kr)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          timeout: 1800s
          command_timeout: 1800s
          script: |
            echo "ðŸš€ ê°œë°œ í™˜ê²½ ë°°í¬ ì‹œìž‘..."
            
            echo "ðŸ”§ Git LFS ì„¤ì¹˜ ì¤‘..."
            sudo yum install git-lfs -y

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ì½”ë“œ ì—…ë°ì´íŠ¸
            cd /home/ec2-user/Final-2team-DrHong
            git fetch origin
            git reset --hard origin/dev
            echo "ðŸ“¦ Git LFS íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            git lfs pull

            # .env íŒŒì¼ í™•ì¸ ë° ìƒì„±
            if [ ! -f ".env" ]; then
              [ -f ".env.example" ] && cp .env.example .env || echo "âš ï¸ .env.example ì—†ìŒ"
            fi

            # --- ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ---
            echo "ðŸ”Œ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ì¤‘..."
            sudo yum install -y nginx
            sudo tee /etc/nginx/conf.d/proxy.conf > /dev/null <<'EOF'
            server {
                listen 80;
                server_name notimo.kro.kr;
                location / {
                    proxy_pass http://localhost:3002;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            server {
                listen 80;
                server_name dev.notimo.kro.kr;
                location / {
                    proxy_pass http://localhost:3001;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            EOF
            sudo systemctl enable --now nginx || sudo systemctl restart nginx

            # ê°œë°œ í™˜ê²½ ì»¨í…Œì´ë„ˆë§Œ ì •ë¦¬ ë° ë°°í¬
            echo "ðŸ§¹ ê¸°ì¡´ ê°œë°œ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker-compose -f docker-compose-dev.yml down --remove-orphans --volumes || true
            echo "ðŸ”¨ ê°œë°œ í™˜ê²½ ë¹Œë“œ ë° ë°°í¬ ì¤‘..."
            docker-compose -f docker-compose-dev.yml up --build -d

            echo "âœ… ê°œë°œ í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
            echo "ðŸŒ ì ‘ì† URL: https://dev.notimo.kro.kr"
            docker-compose -f docker-compose-dev.yml ps

  # -------------------------------------------
  # ìš´ì˜ í™˜ê²½ ë°°í¬ Job (main ë¸Œëžœì¹˜ë§Œ)
  # -------------------------------------------
  deploy-prod:
    # main ë¸Œëžœì¹˜ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      # EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ìš´ì˜ í™˜ê²½ ë°°í¬
      - name: ðŸš€ ìš´ì˜í™˜ê²½ ë°°í¬ (notimo.kro.kr)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          timeout: 1800s
          command_timeout: 1800s
          script: |
            echo "ðŸš€ ìš´ì˜ í™˜ê²½ ë°°í¬ ì‹œìž‘..."

            echo "ðŸ”§ Git LFS ì„¤ì¹˜ ì¤‘..."
            sudo yum install git-lfs -y

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ ë° ì½”ë“œ ì—…ë°ì´íŠ¸
            cd /home/ec2-user/Final-2team-DrHong
            git fetch origin
            git reset --hard origin/main
            echo "ðŸ“¦ Git LFS íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            git lfs pull

            # .env íŒŒì¼ë“¤ í™•ì¸ ë° ìƒì„±
            if [ ! -f ".env" ]; then
              [ -f ".env.example" ] && cp .env.example .env || echo "âš ï¸ .env.example ì—†ìŒ"
            fi
            if [ ! -f "frontend/.env.prod" ]; then
              touch frontend/.env.prod
            fi

            # --- ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ---
            echo "ðŸ”Œ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ì¤‘..."
            sudo yum install -y nginx
            sudo tee /etc/nginx/conf.d/proxy.conf > /dev/null <<'EOF'
            server {
                listen 80;
                server_name notimo.kro.kr;
                location / {
                    proxy_pass http://localhost:3002;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            server {
                listen 80;
                server_name dev.notimo.kro.kr;
                location / {
                    proxy_pass http://localhost:3001;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            EOF
            sudo systemctl enable --now nginx || sudo systemctl restart nginx

            # ìš´ì˜ í™˜ê²½ ì»¨í…Œì´ë„ˆë§Œ ì •ë¦¬ ë° ë°°í¬
            echo "ðŸ§¹ ê¸°ì¡´ ìš´ì˜ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker-compose -f docker-compose-prod.yml down --remove-orphans --volumes || true
            echo "ðŸ”¨ ìš´ì˜ í™˜ê²½ ë¹Œë“œ ë° ë°°í¬ ì¤‘..."
            docker-compose -f docker-compose-prod.yml up --build -d

            echo "âœ… ìš´ì˜ í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
            echo "ðŸŒ ì ‘ì† URL: https://notimo.kro.kr"
            docker-compose -f docker-compose-prod.yml ps
