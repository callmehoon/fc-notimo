name: CI/CD Pipeline

# ===========================================
# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ê²ƒì¸ê°€?
# ===========================================
on:
  push:
    branches:
      - dev   # dev ë¸Œëœì¹˜: CI + ê°œë°œ í™˜ê²½ ë°°í¬
      - main  # main ë¸Œëœì¹˜: ìš´ì˜ í™˜ê²½ ë°°í¬
  pull_request:
    branches:
      - main  # mainìœ¼ë¡œì˜ PR: CIë§Œ ì‹¤í–‰

# ===========================================
# ì‹¤í–‰í•  ì‘ì—…(Job)ë“¤
# ===========================================
jobs:
  # -------------------------------------------
  # CI Job: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ (dev ë¸Œëœì¹˜, PR)
  # -------------------------------------------
  ci:
    # dev ë¸Œëœì¹˜ í‘¸ì‹œ ë˜ëŠ” mainìœ¼ë¡œì˜ PRì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/dev' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. Java 21 í™˜ê²½ ì„¤ì •
      - name: â˜• Java 21 í™˜ê²½ ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: ğŸ“¦ Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: ğŸ”§ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      # 5. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: ğŸ”¨ Spring Boot ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew clean build

  # -------------------------------------------
  # ê°œë°œ í™˜ê²½ ë°°í¬ Job (dev ë¸Œëœì¹˜ë§Œ)
  # -------------------------------------------
  deploy-dev:
    # dev ë¸Œëœì¹˜ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰ + CI ì„±ê³µ í›„
    if: github.ref == 'refs/heads/dev'
    needs: ci
    runs-on: ubuntu-latest

    steps:
      # EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ê°œë°œ í™˜ê²½ ë°°í¬
      - name: ğŸš€ ê°œë°œí™˜ê²½ ë°°í¬ (dev.notimo.kro.kr)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          timeout: 1800s
          command_timeout: 1800s
          script: |
            echo "ğŸš€ ê°œë°œ í™˜ê²½ ë°°í¬ ì‹œì‘..."
            
            # --- ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ---
            sudo yum install git-lfs -y

            # --- í”„ë¡œì íŠ¸ ì½”ë“œ ì—…ë°ì´íŠ¸ ---
            cd /home/ec2-user/Final-2team-DrHong
            git fetch origin
            git reset --hard origin/dev
            echo "ğŸ“¦ Git LFS íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            git lfs pull

            # --- .env íŒŒì¼ ìƒì„± ---
            if [ ! -f ".env" ]; then
              [ -f ".env.example" ] && cp .env.example .env || echo "âš ï¸ .env.example ì—†ìŒ"
            fi

            # --- HTTPS (SSL) ë° ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ---
            echo "ğŸ”Œ HTTPS ë° ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ì¤‘..."
            sudo yum install -y nginx certbot python3-certbot-nginx
            
            # Certbotìœ¼ë¡œ SSL ì¸ì¦ì„œ ë°œê¸‰/ê°±ì‹  (Nginxë¥¼ ì ì‹œ ì¤‘ì§€í•´ì•¼ standalone ë°©ì‹ì´ 80ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ)
            sudo systemctl stop nginx
            sudo certbot certonly --standalone --non-interactive --agree-tos -m ${{ secrets.ADMIN_EMAIL }} -d notimo.kro.kr -d dev.notimo.kro.kr || echo "Certbot ì¸ì¦ì„œ ë°œê¸‰/ê°±ì‹  ì‹¤íŒ¨, ê¸°ì¡´ ì¸ì¦ì„œ ì‚¬ìš©"
            
            # Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • (ì•ˆì •ì ì¸ here-document ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
            NGINX_CONF=$(cat <<'EOF'
            # HTTP to HTTPS ë¦¬ë””ë ‰íŠ¸
            server {
                listen 80;
                server_name notimo.kro.kr dev.notimo.kro.kr;
                
                location /.well-known/acme-challenge/ {
                    root /var/www/html;
                }
                
                location / {
                    return 301 https://$host$request_uri;
                }
            }
            # ê°œë°œ í™˜ê²½ (dev.notimo.kro.kr)
            server {
                server_name dev.notimo.kro.kr;
                location /ai/ { proxy_pass http://localhost:8001/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location /api/ { proxy_pass http://localhost:8081/api/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location / { proxy_pass http://localhost:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                listen 443 ssl;
                ssl_certificate /etc/letsencrypt/live/notimo.kro.kr/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/notimo.kro.kr/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
            }
            # ìš´ì˜ í™˜ê²½ (notimo.kro.kr)
            server {
                server_name notimo.kro.kr;
                location /ai/ { proxy_pass http://localhost:8002/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location /api/ { proxy_pass http://localhost:8082/api/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location / { proxy_pass http://localhost:3002; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                listen 443 ssl;
                ssl_certificate /etc/letsencrypt/live/notimo.kro.kr/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/notimo.kro.kr/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
            }
            EOF
            )
            echo "$NGINX_CONF" | sudo tee /etc/nginx/conf.d/proxy.conf > /dev/null
            
            # SSL íŒŒë¼ë¯¸í„° ìƒì„±
            if [ ! -f "/etc/letsencrypt/ssl-dhparams.pem" ]; then
              sudo openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048
            fi
            if [ ! -f "/etc/letsencrypt/options-ssl-nginx.conf" ]; then
              SSL_OPTIONS_CONF=$(cat <<'EOF'
              ssl_session_cache shared:le_nginx_SSL:10m;
              ssl_session_timeout 1440m;
              ssl_session_tickets off;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_prefer_server_ciphers off;
              ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
              EOF
              )
              echo "$SSL_OPTIONS_CONF" | sudo tee /etc/letsencrypt/options-ssl-nginx.conf > /dev/null
            fi
            
            sudo systemctl enable --now nginx || sudo systemctl restart nginx

            # --- ê°œë°œ í™˜ê²½ ì»¨í…Œì´ë„ˆ ë°°í¬ ---
            echo "ğŸ§¹ ê¸°ì¡´ ê°œë°œ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker-compose -f docker-compose-dev.yml down --remove-orphans --volumes || true
            echo "ğŸ”¨ ê°œë°œ í™˜ê²½ ë¹Œë“œ ë° ë°°í¬ ì¤‘..."
            docker-compose -f docker-compose-dev.yml up --build -d

            # --- ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ ì´ë¯¸ì§€ ì •ë¦¬ ---
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f

            echo "âœ… ê°œë°œ í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ ì ‘ì† URL: https://dev.notimo.kro.kr"
            docker-compose -f docker-compose-dev.yml ps

  # -------------------------------------------
  # ìš´ì˜ í™˜ê²½ ë°°í¬ Job (main ë¸Œëœì¹˜ë§Œ)
  # -------------------------------------------
  deploy-prod:
    # main ë¸Œëœì¹˜ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      # EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ìš´ì˜ í™˜ê²½ ë°°í¬
      - name: ğŸš€ ìš´ì˜í™˜ê²½ ë°°í¬ (notimo.kro.kr)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          timeout: 1800s
          command_timeout: 1800s
          script: |
            echo "ğŸš€ ìš´ì˜ í™˜ê²½ ë°°í¬ ì‹œì‘..."

            # --- ê¸°ë³¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ---
            sudo yum install git-lfs -y

            # --- í”„ë¡œì íŠ¸ ì½”ë“œ ì—…ë°ì´íŠ¸ ---
            cd /home/ec2-user/Final-2team-DrHong
            git fetch origin
            git reset --hard origin/main
            echo "ğŸ“¦ Git LFS íŒŒì¼ë“¤ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            git lfs pull

            # --- .env íŒŒì¼ ìƒì„± ---
            if [ ! -f ".env" ]; then
              [ -f ".env.example" ] && cp .env.example .env || echo "âš ï¸ .env.example ì—†ìŒ"
            fi
            if [ ! -f "frontend/.env.prod" ]; then
              touch frontend/.env.prod
            fi

            # --- HTTPS (SSL) ë° ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ---
            echo "ğŸ”Œ HTTPS ë° ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • ì¤‘..."
            sudo yum install -y nginx certbot python3-certbot-nginx
            
            # Certbotìœ¼ë¡œ SSL ì¸ì¦ì„œ ë°œê¸‰/ê°±ì‹  (Nginxë¥¼ ì ì‹œ ì¤‘ì§€í•´ì•¼ standalone ë°©ì‹ì´ 80ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ)
            sudo systemctl stop nginx
            sudo certbot certonly --standalone --non-interactive --agree-tos -m ${{ secrets.ADMIN_EMAIL }} -d notimo.kro.kr -d dev.notimo.kro.kr || echo "Certbot ì¸ì¦ì„œ ë°œê¸‰/ê°±ì‹  ì‹¤íŒ¨, ê¸°ì¡´ ì¸ì¦ì„œ ì‚¬ìš©"
            
            # Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì • (ì•ˆì •ì ì¸ here-document ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
            NGINX_CONF=$(cat <<'EOF'
            # HTTP to HTTPS ë¦¬ë””ë ‰íŠ¸
            server {
                listen 80;
                server_name notimo.kro.kr dev.notimo.kro.kr;
                
                location /.well-known/acme-challenge/ {
                    root /var/www/html;
                }
                
                location / {
                    return 301 https://$host$request_uri;
                }
            }
            # ê°œë°œ í™˜ê²½ (dev.notimo.kro.kr)
            server {
                server_name dev.notimo.kro.kr;
                location /ai/ { proxy_pass http://localhost:8001/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location /api/ { proxy_pass http://localhost:8081/api/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location / { proxy_pass http://localhost:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                listen 443 ssl;
                ssl_certificate /etc/letsencrypt/live/notimo.kro.kr/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/notimo.kro.kr/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
            }
            # ìš´ì˜ í™˜ê²½ (notimo.kro.kr)
            server {
                server_name notimo.kro.kr;
                location /ai/ { proxy_pass http://localhost:8002/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location /api/ { proxy_pass http://localhost:8082/api/; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                location / { proxy_pass http://localhost:3002; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; }
                listen 443 ssl;
                ssl_certificate /etc/letsencrypt/live/notimo.kro.kr/fullchain.pem;
                ssl_certificate_key /etc/letsencrypt/live/notimo.kro.kr/privkey.pem;
                include /etc/letsencrypt/options-ssl-nginx.conf;
                ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
            }
            EOF
            )
            echo "$NGINX_CONF" | sudo tee /etc/nginx/conf.d/proxy.conf > /dev/null
            
            # SSL íŒŒë¼ë¯¸í„° ìƒì„±
            if [ ! -f "/etc/letsencrypt/ssl-dhparams.pem" ]; then
              sudo openssl dhparam -out /etc/letsencrypt/ssl-dhparams.pem 2048
            fi
            if [ ! -f "/etc/letsencrypt/options-ssl-nginx.conf" ]; then
              SSL_OPTIONS_CONF=$(cat <<'EOF'
              ssl_session_cache shared:le_nginx_SSL:10m;
              ssl_session_timeout 1440m;
              ssl_session_tickets off;
              ssl_protocols TLSv1.2 TLSv1.3;
              ssl_prefer_server_ciphers off;
              ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";
              EOF
              )
              echo "$SSL_OPTIONS_CONF" | sudo tee /etc/letsencrypt/options-ssl-nginx.conf > /dev/null
            fi
            
            sudo systemctl enable --now nginx || sudo systemctl restart nginx

            # --- ìš´ì˜ í™˜ê²½ ì»¨í…Œì´ë„ˆ ë°°í¬ ---
            echo "ğŸ§¹ ê¸°ì¡´ ìš´ì˜ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker-compose -f docker-compose-prod.yml down --remove-orphans --volumes || true
            echo "ğŸ”¨ ìš´ì˜ í™˜ê²½ ë¹Œë“œ ë° ë°°í¬ ì¤‘..."
            docker-compose -f docker-compose-prod.yml up --build -d

            # --- ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ ì´ë¯¸ì§€ ì •ë¦¬ ---
            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë„ì»¤ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f

            echo "âœ… ìš´ì˜ í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ ì ‘ì† URL: https://notimo.kro.kr"
            docker-compose -f docker-compose-prod.yml ps
