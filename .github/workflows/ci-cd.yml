name: CI/CD Pipeline

# ===========================================
# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  ê²ƒì¸ê°€?
# ===========================================
on:
  push:
    branches:
      - dev   # dev ë¸Œëœì¹˜: CI + ê°œë°œ í™˜ê²½ ë°°í¬
      - main  # main ë¸Œëœì¹˜: ìš´ì˜ í™˜ê²½ ë°°í¬
  pull_request:
    branches:
      - main  # mainìœ¼ë¡œì˜ PR: CIë§Œ ì‹¤í–‰

# ===========================================
# ì‹¤í–‰í•  ì‘ì—…(Job)ë“¤
# ===========================================
jobs:
  # -------------------------------------------
  # CI Job: ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ (dev ë¸Œëœì¹˜, PR)
  # -------------------------------------------
  ci:
    # dev ë¸Œëœì¹˜ í‘¸ì‹œ ë˜ëŠ” mainìœ¼ë¡œì˜ PRì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/dev' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. Java 21 í™˜ê²½ ì„¤ì •
      - name: â˜• Java 21 í™˜ê²½ ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Gradle ìºì‹œ ì„¤ì • (ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: ğŸ“¦ Gradle ìºì‹œ ì„¤ì •
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: ğŸ”§ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      # 5. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
      - name: ğŸ”¨ Spring Boot ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew clean build

  # -------------------------------------------
  # ê°œë°œ í™˜ê²½ ë°°í¬ Job (dev ë¸Œëœì¹˜ë§Œ)
  # -------------------------------------------
  deploy-dev:
    # dev ë¸Œëœì¹˜ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰ + CI ì„±ê³µ í›„
    if: github.ref == 'refs/heads/dev'
    needs: ci
    runs-on: ubuntu-latest

    steps:
      # EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ê°œë°œ í™˜ê²½ ë°°í¬
      - name: ğŸš€ ê°œë°œí™˜ê²½ ë°°í¬ (dev.notimo.kro.kr)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ ê°œë°œ í™˜ê²½ ë°°í¬ ì‹œì‘..."

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ec2-user

            # í”„ë¡œì íŠ¸ í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ì½”ë“œ ì—…ë°ì´íŠ¸
            if [ -d "Final-2team-DrHong" ]; then
              echo "ğŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ í´ë” ë°œê²¬. ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
              cd Final-2team-DrHong
              # PATë¥¼ ì‚¬ìš©í•œ ì¸ì¦ìœ¼ë¡œ git pull
              git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/Kernel180-BE12/Final-2team-DrHong.git
              git pull origin dev
              git remote set-url origin https://github.com/Kernel180-BE12/Final-2team-DrHong.git
            else
              echo "ğŸ“ í”„ë¡œì íŠ¸ í´ë” ì—†ìŒ. ìƒˆë¡œ í´ë¡  ì¤‘..."
              git clone https://${{ secrets.GH_PAT }}@github.com/Kernel180-BE12/Final-2team-DrHong.git
              cd Final-2team-DrHong
              git checkout dev
              git remote set-url origin https://github.com/Kernel180-BE12/Final-2team-DrHong.git
            fi

            # .env íŒŒì¼ í™•ì¸ ë° ìƒì„±
            if [ ! -f ".env" ]; then
              if [ -f ".env.example" ]; then
                echo "ğŸ“„ .env íŒŒì¼ ìƒì„± ì¤‘..."
                cp .env.example .env
              else
                echo "âš ï¸ ê²½ê³ : .env.example íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              fi
            fi

            # ê¸°ì¡´ ê°œë°œ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (í¬íŠ¸ 3001)
            echo "ğŸ§¹ ê¸°ì¡´ ê°œë°œ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker compose -f docker-compose-dev.yml down --remove-orphans || true

            # ê°œë°œ í™˜ê²½ ë°°í¬ (H2 DB, í¬íŠ¸ 3001)
            echo "ğŸ”¨ ê°œë°œ í™˜ê²½ ë¹Œë“œ ë° ë°°í¬ ì¤‘... (H2 DB, dev.notimo.kro.kr)"
            docker compose -f docker-compose-dev.yml up --build -d

            # ë°°í¬ ê²°ê³¼ í™•ì¸
            echo "âœ… ê°œë°œ í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ ì ‘ì† URL: https://dev.notimo.kro.kr"
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker compose -f docker-compose-dev.yml ps

  # -------------------------------------------
  # ìš´ì˜ í™˜ê²½ ë°°í¬ Job (main ë¸Œëœì¹˜ë§Œ)
  # -------------------------------------------
  deploy-prod:
    # main ë¸Œëœì¹˜ í‘¸ì‹œì¼ ë•Œë§Œ ì‹¤í–‰
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      # EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ìš´ì˜ í™˜ê²½ ë°°í¬
      - name: ğŸš€ ìš´ì˜í™˜ê²½ ë°°í¬ (notimo.kro.kr)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸš€ ìš´ì˜ í™˜ê²½ ë°°í¬ ì‹œì‘..."

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ec2-user

            # í”„ë¡œì íŠ¸ í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ì½”ë“œ ì—…ë°ì´íŠ¸
            if [ -d "Final-2team-DrHong" ]; then
              echo "ğŸ“ ê¸°ì¡´ í”„ë¡œì íŠ¸ í´ë” ë°œê²¬. ìµœì‹  ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
              cd Final-2team-DrHong
              # PATë¥¼ ì‚¬ìš©í•œ ì¸ì¦ìœ¼ë¡œ git pull
              git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/Kernel180-BE12/Final-2team-DrHong.git
              git pull origin main
              git remote set-url origin https://github.com/Kernel180-BE12/Final-2team-DrHong.git
            else
              echo "ğŸ“ í”„ë¡œì íŠ¸ í´ë” ì—†ìŒ. ìƒˆë¡œ í´ë¡  ì¤‘..."
              git clone https://${{ secrets.GH_PAT }}@github.com/Kernel180-BE12/Final-2team-DrHong.git
              cd Final-2team-DrHong
              git checkout main
              git remote set-url origin https://github.com/Kernel180-BE12/Final-2team-DrHong.git
            fi

            # .env íŒŒì¼ í™•ì¸ ë° ìƒì„±
            if [ ! -f ".env" ]; then
              if [ -f ".env.example" ]; then
                echo "ğŸ“„ .env íŒŒì¼ ìƒì„± ì¤‘..."
                cp .env.example .env
              else
                echo "âš ï¸ ê²½ê³ : .env.example íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
              fi
            fi

            # ê¸°ì¡´ ìš´ì˜ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (í¬íŠ¸ 3002)
            echo "ğŸ§¹ ê¸°ì¡´ ìš´ì˜ í™˜ê²½ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker compose -f docker-compose-prod.yml down --remove-orphans || true

            # ìš´ì˜ í™˜ê²½ ë°°í¬ (MySQL RDS, í¬íŠ¸ 3002)
            echo "ğŸ”¨ ìš´ì˜ í™˜ê²½ ë¹Œë“œ ë° ë°°í¬ ì¤‘... (MySQL RDS, notimo.kro.kr)"
            docker compose -f docker-compose-prod.yml up --build -d

            # ë°°í¬ ê²°ê³¼ í™•ì¸
            echo "âœ… ìš´ì˜ í™˜ê²½ ë°°í¬ ì™„ë£Œ!"
            echo "ğŸŒ ì ‘ì† URL: https://notimo.kro.kr"
            echo "ğŸ“Š ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker compose -f docker-compose-prod.yml ps
